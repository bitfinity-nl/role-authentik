---
# Title: Authentik
#
# Author: Bitfinity / L. Rutten
# Owner: Bitfinity / L. Rutten
#
# File: tasks/main.yml
#
# Description:
#   authentik is an open-source Identity Provider focused on flexibility and versatility.
#

- hosts: 127.0.0.1
  connection: local
  become: true

  pre_tasks:
    #- name: "Include defaults file defaults/main.yml"
    #  include_vars: defaults/main.yml

    - name: "Include defaults file /root/.ansible-config.yml"
      include_vars: /root/.ansible-config.yml
    
  vars:
    # -- SMTP settings --
    # 
    auth_email_host                : 'localhost'
    auth_email_port                : '587'
    auth_email_username            : 'user@example.com'
    auth_email_password            : 'Welcome123'
    auth_email_use_tls             : 'false'
    auth_email_use_ssl             : 'false'
    auth_email_timeout             : '10'
    auth_email_from                : 'authentik@localhost'

    # -- GeoIP settings --
    #
    auth_geopipupdate_account_id   : '*your account ID*'
    auth_geopipupdate_license_key  : '* your license key*'
    auth_authentik_authentik_geoip : '/geoip/GeoLite2-City.mmdb'
  
    # -- Apache2 settings--
    apache2_application_name     : 'Authentik'
    apache2_documentroot         : '/var/www/html'
    #apache2_allow_from_dir_admin : '10.1.0.0/24'
    apache2_servername           : '{{ certbot_servername }}'
    apache2_serveradmin          : '{{ certbot_serveradmin }}'
    apache2_cert_file            : '/etc/letsencrypt/live/{{ certbot_serveralias }}/fullchain.pem'
    apache2_cert_keyfile         : '/etc/letsencrypt/live/{{ certbot_serveralias }}/privkey.pem'

  handlers:
    - include: handlers/main.yml
    
  roles:
    - role-certbot-apache2
  
  tasks:
    - name: "Include tasks/01-authentik.yml"
      include_tasks: tasks/01-authentik.yml
 
    - name: "Include tasks/02-apache2.yml"
      include_tasks: tasks/02-apache2.yml


